<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chess Tower Defense (Playable)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #437d3c;
      overflow: hidden;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #game {
      width: 80vmin;
      height: 80vmin;
      min-width: 320px;
      min-height: 320px;
      max-width: 95vw;
      max-height: 95vh;
      position: relative;
      box-shadow: 0 0 30px #222;
      border-radius: 12px;
      background: #264d21;
      overflow: hidden;
    }
    #board {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      position: absolute;
      top: 0; left: 0;
      z-index: 1;
    }
    .cell {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .grass-light {
      background: #83b77b;
    }
    .grass-dark {
      background: #437d3c;
    }
    .piece {
      width: 70%;
      height: 70%;
      cursor: pointer;
      transition: transform 0.1s;
      z-index: 2;
      position: absolute;
      left: 15%;
      top: 15%;
      pointer-events: auto;
    }
    .piece.selected {
      transform: scale(1.18);
      filter: drop-shadow(0 0 4px #fff);
      z-index: 10;
    }
    .enemy {
      width: 60%;
      height: 60%;
      position: absolute;
      z-index: 3;
      left: 20%;
      top: 20%;
      pointer-events: none;
      animation: enemyMove 0.7s linear;
    }
    @keyframes enemyMove {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.5); }
    }
    .hint {
      position: absolute;
      width: 38%;
      height: 38%;
      left: 31%;
      top: 31%;
      background: rgba(255,255,0,0.2);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
    }
    #ui {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-family: sans-serif;
      font-size: 1.2em;
      text-shadow: 0 2px 6px #222;
      z-index: 11;
      background: rgba(50,80,40,0.6);
      padding: 8px 18px;
      border-radius: 8px;
    }
    #selector {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 12;
      background: rgba(40,70,40,0.75);
      padding: 6px 16px;
      border-radius: 8px;
    }
    .selectpiece {
      width: 34px; height: 34px;
      background: none; border: none; cursor: pointer;
      border-radius: 50%;
      margin: 0 2px;
      transition: background 0.17s;
      display: flex; align-items: center; justify-content: center;
    }
    .selectpiece.selected {
      background: rgba(255,255,0,0.18);
    }
    #placemodebtn {
      position: absolute;
      top: 55px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 13;
      background: #f3e37d;
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      font-size: 1em;
      cursor: pointer;
      font-family: sans-serif;
      box-shadow: 0 2px 8px #2221;
    }
    #placemodebtn.active {
      background: #ffe586;
      font-weight: bold;
      border: 2px solid #eecc44;
    }
    @media (max-width: 600px) {
      #game { width: 97vw; height: 97vw; }
      #placemodebtn { font-size: 0.9em; padding: 6px 10px; }
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="board"></div>
    <button id="placemodebtn" class="active">Place Defenses</button>
    <div id="ui"></div>
    <div id="selector"></div>
  </div>
<!-- ... Keep all your existing head content ... -->
<script>
/** PIECE SVGS ... unchanged ... **/

const PIECE_ORDER = ["pawn","rook","bishop","knight","queen","king"];
const PIECE_NAMES = { pawn: "Pawn", rook: "Rook", bishop: "Bishop", knight: "Knight", queen: "Queen", king: "King" };
const PIECE_COSTS = { pawn: 0, bishop: 5, knight: 10, rook: 15, queen: 20, king: 0 };
const PIECE_LIMITS = { pawn: 8, bishop: 2, knight: 2, rook: 2, queen: 1, king: 1 };
const PIECE_HEALTH = { pawn: 1, bishop: 2, knight: 3, rook: 4, queen: 5, king: 10 };
let placedCounts = { pawn: 0, bishop: 0, knight: 0, rook: 0, queen: 0, king: 0 };

/** GAME STATE **/
let board = Array.from({length:8},()=>Array(8).fill(null));
let enemies = [];
let selectedPieceType = "pawn";
let selectedCell = null;
let placingMode = true;
let tick = 0;
let lives = 10;
let score = 0;
let money = 10;
let spawnRate = 120;
let enemyMoveRate = 24;
let nextWave = 0;

/** Place King at start, only one! **/
function placeKing() {
  board[3][0] = {type:"king", health: PIECE_HEALTH["king"]};
  placedCounts.king = 1;
}

/** RENDER BOARD ... unchanged except for enemy spawn logic and health display **/

/** PIECE SELECTOR **/
function renderSelector() {
  selectorDiv.innerHTML = "";
  PIECE_ORDER.forEach(type => {
    let btn = document.createElement("button");
    btn.className = "selectpiece" + (selectedPieceType===type?" selected":"");
    btn.innerHTML = PIECE_SVGS[type];
    btn.onclick = ()=>{
      selectedPieceType=type;
      placingMode=true;
      selectedCell=null;
      updatePlaceBtn();
      renderSelector();
      renderBoard();
    };
    btn.title = PIECE_NAMES[type] + ` ($${PIECE_COSTS[type]}, ${PIECE_LIMITS[type]-placedCounts[type]} left)`;
    selectorDiv.appendChild(btn);
  });
}

/** CELL CLICK HANDLER **/
function cellClick(r,c) {
  if (placingMode) {
    // Place piece if cell is empty, not limited, and enough money
    if (!board[r][c] && placedCounts[selectedPieceType] < PIECE_LIMITS[selectedPieceType] && money >= PIECE_COSTS[selectedPieceType]) {
      board[r][c] = {type:selectedPieceType, health: PIECE_HEALTH[selectedPieceType]};
      placedCounts[selectedPieceType]++;
      money -= PIECE_COSTS[selectedPieceType];
      renderBoard();
      renderSelector();
    } else {
      // select piece to show moves
      selectedCell = [r,c];
      placingMode=false;
      updatePlaceBtn();
      renderBoard();
    }
  } else {
    // move piece (if allowed)
    let [sr,sc]=selectedCell;
    let piece = board[sr][sc];
    if (piece && validMove(piece.type,sr,sc,r,c) && !board[r][c]) {
      board[r][c]=piece;
      board[sr][sc]=null;
      placingMode=true;
      selectedCell=null;
      updatePlaceBtn();
      renderBoard();
      renderSelector();
    } else if (sr===r && sc===c) {
      placingMode=true;
      selectedCell=null;
      updatePlaceBtn();
      renderBoard();
      renderSelector();
    }
  }
}

/** ENEMY LOGIC ROTATED **/
function spawnEnemy() {
  // Spawn on rightmost column, random row
  let row = Math.floor(Math.random()*8);
  enemies.push({r:row, c:7});
}
function moveEnemies() {
  for (let enemy of enemies) {
    // Move left if not blocked
    if (enemy.c>0 && !board[enemy.r][enemy.c-1]) {
      enemy.c--;
    } else {
      // Check if captured by piece
      let piece = board[enemy.r][enemy.c];
      if (piece) {
        score++;
        piece.health--;
        if (piece.health <= 0) {
          placedCounts[piece.type]--;
          board[enemy.r][enemy.c]=null;
        }
        enemy.remove=true;
      } else if (enemy.c===0) {
        lives--;
        enemy.remove=true;
      }
    }
  }
  enemies = enemies.filter(e=>!e.remove);
}

/** MONEY GAIN **/
function gainMoney() {
  if (tick%60===0) money += 2; // Every ~second
}

/** MAIN GAME LOOP **/
function gameTick() {
  tick++;
  gainMoney();
  if (lives<=0) {
    uiDiv.innerHTML = `<b>Game Over!</b> Score: ${score} <button onclick="restartGame()">Restart</button>`;
    return;
  }
  if (tick%spawnRate===0) spawnEnemy();
  if (tick%enemyMoveRate===0) moveEnemies();
  renderBoard();
  uiDiv.innerHTML = `Score: <b>${score}</b> &nbsp; Lives: <b>${lives}</b> &nbsp; Money: <b>$${money}</b> <button onclick="clearBoard()">Clear Board</button>`;
  requestAnimationFrame(gameTick);
}

function clearBoard() {
  board = Array.from({length:8},()=>Array(8).fill(null));
  placedCounts = { pawn: 0, bishop: 0, knight: 0, rook: 0, queen: 0, king: 0 };
  placeKing();
  placingMode=true;
  selectedCell=null;
  updatePlaceBtn();
  renderBoard();
  renderSelector();
}
function restartGame() {
  board = Array.from({length:8},()=>Array(8).fill(null));
  enemies = [];
  placedCounts = { pawn: 0, bishop: 0, knight: 0, rook: 0, queen: 0, king: 0 };
  placeKing();
  selectedCell=null;
  tick=0;
  lives=10;
  score=0;
  money=10;
  placingMode=true;
  updatePlaceBtn();
  renderBoard();
  renderSelector();
  gameTick();
}

// Place mode button handler ... unchanged ...

// INIT
placeKing();
renderBoard();
renderSelector();
updatePlaceBtn();
gameTick();

</script>
</body>
</html>
